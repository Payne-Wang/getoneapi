# 多线程 API 登录与渠道数据获取脚本

## 项目简介

本项目提供了一个用于批量登录多个 API 站点并获取渠道信息的 R 脚本。通过使用多线程技术，脚本能够高效地处理大量请求，适用于需要同时管理多个 API 接口的场景。

## 功能

- **批量登录**：模拟用户登录多个 OneAPI 站点。
- **渠道数据获取**：获取各个站点的渠道信息。
- **多线程处理**：利用多线程技术加速请求处理，提高效率。
- **错误处理**：使用 `safely` 函数包装登录函数，确保在出现错误时不中断整个流程。

## 环境要求

- **操作系统**：Windows / macOS / Linux
- **R 版本**：建议使用 R 4.0 及以上版本

## 所需 R 包

脚本依赖以下 R 包，请确保已安装这些包：

- `httr`
- `jsonlite`
- `furrr`
- `future`
- `dplyr` （假设用户在代码中使用了 `%>%`，虽然未显示加载）

你可以使用以下命令安装缺失的包：

```R
install.packages(c("httr", "jsonlite", "furrr", "future", "dplyr"))
```

## 安装与配置

1. **克隆或下载项目代码**到本地计算机。

2. **准备 URL 列表文件**：

   创建一个名为 `360-newapi` 的文本文件，使用制表符（Tab）分隔。文件中每一行应包含一个 API 站点的基本 URL，例如：

   ```
   https://api.site1.com
   https://api.site2.com
   https://api.site3.com
   ```

3. **调整脚本设置**：

   - 确保 `360-newapi` 文件位于脚本所在的工作目录，或修改脚本中的路径以指向正确的位置。
   - 根据需要调整多线程的工作线程数（当前设置为 10 个线程）。
   - 如有必要，修改登录所使用的用户名和密码（当前为 `root` 和 `123456`）。

## 使用说明

1. **加载所需包**：

   确保在 R 环境中加载了所有需要的包：

   ```R
   library(httr)
   library(jsonlite)
   library(furrr)
   library(future)
   library(dplyr)  # 若使用 %>%
   ```

2. **设置多线程计划**：

   ```R
   plan(multisession, workers = 10)  # 根据实际 CPU 核心数调整
   ```

3. **读取 API URL 列表**：

   ```R
   url <- read.table("360-newapi", sep = "\t") %>% .$V1
   ```

4. **定义登录函数**：

   脚本中已包含 `login` 函数，用于模拟登录操作。

5. **并行执行登录操作**：

   ```R
   results <- future_map(url, ~safe_login("root", "123456", url = .), .progress = TRUE)
   ```

   登录结果会在控制台输出“登录成功”信息。

6. **获取渠道信息**：

   ```R
   channel_results <- future_map(url, ~channel(1, 10, url = .), .progress = TRUE)
   ```

   渠道数据会在控制台打印 `content$data` 的内容。

## 输出说明

- **登录结果**：在控制台显示每个成功登录的 URL，例如：

  ```
  [1] "登录成功：https://api.site1.com"
  [1] "登录成功：https://api.site2.com"
  ```

- **渠道数据**：在控制台显示每个 API 站点返回的渠道数据。

## 错误处理

- 使用 `safely` 函数包装登录函数，以防止单个请求失败中断整个流程。
- 若登录或获取渠道数据失败，相关错误信息不会中断脚本执行，可在 `results` 和 `channel_results` 中查看具体错误。

## 注意事项

- **安全性**：脚本中使用明文存储用户名和密码，请确保在安全环境中运行，避免泄露敏感信息。
- **API 响应时间**：根据各 API 站点的响应速度，调整 `timeout` 设置以适应不同的网络环境。
- **SSL 验证**：当前脚本中禁用了 SSL 证书验证（`ssl_verifypeer = FALSE`），若目标 API 需要严格的 SSL 验证，请根据需要调整配置。

## 扩展与自定义

- **多线程数量**：可根据计算机的实际 CPU 核心数调整 `workers` 参数，以优化性能。
- **函数扩展**：可根据需要扩展更多 API 操作，如数据提交、更新等。
- **结果保存**：可将登录和渠道数据结果保存到文件中，便于后续分析。例如，使用 `write.csv` 或 `saveRDS` 函数。
